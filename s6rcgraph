#! /bin/env python

import os
import pprint
import sys

hm = { 'bundle':[], 'longrun':[], 'oneshot':[] }

def get_content(path):
    ret = None
    if os.path.isfile(path):
        f = open(path, 'r')
        ret = f.read().strip().split('\n')
        f.close()
    return ret

def get_type(dir_name):
    return get_content(dir_name + '/type')[0]

def get_dependencies(rc_type, dir_name):
    return get_content(dir_name + ('/dependencies', '/contents')[(rc_type == 'bundle')])

def get_consumers(dir_name):
    return get_content(dir_name + '/consumer-for')

if len(sys.argv) == 2:
    os.chdir(sys.argv[1])

pipes = []

for dir_name in os.listdir('.'):
    if dir_name[0] == '.':
        continue
    rc_type = get_type(dir_name)
    hm[rc_type] += [{ dir_name: get_dependencies(rc_type, dir_name)}]
    consumers = get_consumers(dir_name)
    if consumers:
        pipes += [{ dir_name: consumers }]

#pprint.pprint(hm)
#pprint.pprint(pipes)

print("digraph G {")
print("\tnode [ shape = box ]")

print("\tsubgraph bundle {")
print("\t\tnode [ color = orange ]")
for j in hm['bundle']:
    for k in j:
        print('\t\t"' + k + '"')
print("\t}")

print("\tsubgraph longrun {")
print("\t\tnode [ color = red ]")
for j in hm['longrun']:
    for k in j:
        print('\t\t"' + k + '"')
print("\t}")
for i in hm:
#    if i == 'bundle':
#        continue
    for j in hm[i]:
        for k in j:
            if j[k]:
                for l in j[k]:
                    if len(l):
                        print('\t"' + k + '" -> "' + l + '"')

print("\tsubgraph log {")
print("\t\tedge [ color = blue, style = dotted ]")
for i in pipes:
    for j in i:
        for k in i[j]:
            print('\t\t"' + k + '" -> "' + j + '"')
print("\t}")

print("}")
